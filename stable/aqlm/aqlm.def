Bootstrap: localimage
From: /apps/containers/Ubuntu/Ubuntu-noble-20250127.sif

%files
    /mimer/NOBACKUP/groups/naiss2025-22-104/REST/REST-at/aqlm-requirements.txt

%post
    apt-get update -y
    apt-get upgrade -y

    apt-get install -y --no-install-recommends \
        build-essential \
        wget \
        git \
        cmake \
        python3-full \
        python3-dev \
	python3.12-venv \
	python-is-python3 \
        libxml2 \
        ninja-build \
        curl 

    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
    dpkg -i cuda-keyring_1.1-1_all.deb
    apt-get update
    apt-get -y install cuda-toolkit-12-9

    python3.12 -m venv /opt/aqlm-venv

    # Activate virtualenv and install dependencies
    /opt/aqlm-venv/bin/pip install --upgrade pip
    /opt/aqlm-venv/bin/pip install -r /mimer/NOBACKUP/groups/naiss2025-22-104/REST/REST-at/aqlm-requirements.txt
    /opt/aqlm-venv/bin/pip install setuptools

%environment
    # Add CUDA tools to path
    export PATH=/opt/aqlm-venv/bin:/usr/local/cuda/bin:$PATH
    export CPATH=/usr/local/cuda/include:$CPATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export CFLAGS="-I/usr/local/cuda/include $CFLAGS"
    export LIBRARY_PATH=/usr/local/cuda/lib64:$LIBRARY_PATH
    export CUDA_HOME=/usr/local/cuda
